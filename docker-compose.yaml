services:
  nats:
    image: nats:2-alpine
    ports:
      - "127.0.0.1:4222:4222"
      - "127.0.0.1:8222:8222"
    volumes:
      - nats-data:/data
      - ./config/nats-server.conf:/nats-server.conf
    command: ["nats-server", "--config", "/nats-server.conf"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8222/healthz || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 10

  postgres:
    # postgres 18 was releated on 2025-09-25
    image: postgres:18-alpine
    restart: always
    shm_size: 256mb
    command: ["postgres", "-c", "wal_level=logical"]
    environment:
      POSTGRES_USER: jetstream
      POSTGRES_PASSWORD: jetstream
      POSTGRES_DB: jetstream
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./schema/migrate.sh:/docker-entrypoint-initdb.d/migrate.sh
      - ./schema/migrations:/docker-entrypoint-initdb.d/migrations
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jetstream -d jetstream"]
      interval: 2s
      timeout: 5s
      retries: 10

  redis:
    image: redis:8-alpine
    restart: always
    volumes:
      - redis-data:/data
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10

  debezium:
    image: quay.io/debezium/server:3.0
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    volumes:
      - debezium-data:/debezium/data
    environment:
      # Sink: NATS JetStream
      DEBEZIUM_SINK_TYPE: nats-jetstream
      DEBEZIUM_SINK_NATS_JETSTREAM_URL: nats://nats:4222
      DEBEZIUM_SINK_NATS_JETSTREAM_CREATE_STREAM: "true"
      DEBEZIUM_SINK_NATS_JETSTREAM_SUBJECTS: cdc.>
      # Source: PostgreSQL
      DEBEZIUM_SOURCE_CONNECTOR_CLASS: io.debezium.connector.postgresql.PostgresConnector
      DEBEZIUM_SOURCE_OFFSET_STORAGE_FILE_FILENAME: data/offsets.dat
      DEBEZIUM_SOURCE_OFFSET_FLUSH_INTERVAL_MS: "0"
      DEBEZIUM_SOURCE_DATABASE_HOSTNAME: postgres
      DEBEZIUM_SOURCE_DATABASE_PORT: "5432"
      DEBEZIUM_SOURCE_DATABASE_USER: jetstream
      DEBEZIUM_SOURCE_DATABASE_PASSWORD: jetstream
      DEBEZIUM_SOURCE_DATABASE_DBNAME: jetstream
      DEBEZIUM_SOURCE_PLUGIN_NAME: pgoutput
      DEBEZIUM_SOURCE_TOPIC_PREFIX: cdc
      DEBEZIUM_SOURCE_TABLE_INCLUDE_LIST: public.users,public.orders
      DEBEZIUM_SOURCE_SLOT_NAME: debezium_slot
      # Transforms
      DEBEZIUM_TRANSFORMS: unwrap
      DEBEZIUM_TRANSFORMS_UNWRAP_TYPE: io.debezium.transforms.ExtractNewRecordState
      DEBEZIUM_TRANSFORMS_UNWRAP_DROP_TOMBSTONES: "true"
      DEBEZIUM_TRANSFORMS_UNWRAP_DELETE_HANDLING_MODE: rewrite
      DEBEZIUM_TRANSFORMS_UNWRAP_ADD_FIELDS: op,table,source.ts_ms
      # Format
      DEBEZIUM_FORMAT_KEY: json
      DEBEZIUM_FORMAT_VALUE: json
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/q/health/ready || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s

  write-gateway:
    build:
      context: .
      dockerfile: packages/write-gateway/Dockerfile
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      nats:
        condition: service_healthy
    environment:
      NATS_URL: nats://nats:4222
      PORT: "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10

  write-processor:
    build:
      context: .
      dockerfile: packages/write-processor/Dockerfile
    depends_on:
      nats:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NATS_URL: nats://nats:4222
      DATABASE_URL: postgres://jetstream:jetstream@postgres:5432/jetstream
      REDIS_URL: redis://redis:6379

  read-api:
    build:
      context: .
      dockerfile: packages/read-api/Dockerfile
    ports:
      - "127.0.0.1:3001:3001"
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      debezium:
        condition: service_healthy
    environment:
      NATS_URL: nats://nats:4222
      REDIS_URL: redis://redis:6379
      DATABASE_URL: postgres://jetstream:jetstream@postgres:5432/jetstream
      PORT: "3001"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10

  frontend:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile
    ports:
      - "0.0.0.0:80:80" # public
    depends_on:
      write-gateway:
        condition: service_healthy
      read-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/ || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  nats-data:
  postgres-data:
  redis-data:
  debezium-data:
